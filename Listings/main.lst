C51 COMPILER V9.60.7.0   MAIN                                                              01/30/2026 12:49:44 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE src\main.c OPTIMIZE(9,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\
                    -main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <REG52.H>
   2          
   3          
   4          // Local Headers
   5          #include "types.h"
   6          #include "helpers.h"
   7          #include "config.h"
   8          #include "hardware.h"
   9          #include "bitboard.h"
  10          #include "uart.h"
  11          #include "shift_registers.h"
  12          #include "tm_ssd.h"
  13          #include "interrupts.h"
  14          #include "move_gen.h"
  15              
  16              
  17          #define CLEAR_LEDS() set_leds(&ZeroBoard)
  18              
  19          bit JustEnteredState = 1;
  20          U8 CurrentMainState = TURNED_ON;
  21          U8 CurrentDetectionState = NONE;
  22          
  23          U8 ErrorFlashCount = 0;
  24          
  25          U8 DelayCounter = 0;
  26          
  27          int main(void) {
  28   1        
  29   1        uart_init();
  30   1        init_shift_reg();
  31   1        CLEAR_LEDS();
  32   1        
  33   1        TURN = WHITE;
  34   1        
  35   1        DelayCounter = 10;
  36   1        while (1) {
  37   2          
  38   2          if (rxPacketReady) process_rx_packet();
  39   2          if (txPacketReady) process_tx_packet();
  40   2          
  41   2          if (MOVE_RECEIVED) {
  42   3            
  43   3            EA = 0;  // Disable interrupts
  44   3            MOVE_RECEIVED = 0;
  45   3            EA = 1;  // Re-enable
  46   3            tm_display_digits(MoveSquares[1] + 9 + 1, MoveSquares[0] + 1, MoveSquares[3] + 9 + 1, MoveSquares[2] + 
             -1);
  47   3            CurrentMainState = AWAIT_MOVE_SET;
  48   3            JustEnteredState = 1;
  49   3          }
  50   2          
  51   2          
  52   2          if (DelayCounter > 0) DelayCounter--;
  53   2          switch (CurrentMainState) {
C51 COMPILER V9.60.7.0   MAIN                                                              01/30/2026 12:49:44 PAGE 2   

  54   3            
  55   3            case TURNED_ON:
  56   3              if (JustEnteredState) {
  57   4                tm_display_digits(1, 2, 2, 1);
  58   4                JustEnteredState = 0;
  59   4                set_leds(&OneBoard);
  60   4              }
  61   3              
  62   3              if (CONNECTED) {
  63   4                JustEnteredState = 1;
  64   4                DelayCounter = 10;
  65   4                CurrentMainState = AWAIT_INITIAL_POSITION_SET;
  66   4              }
  67   3              break;
  68   3              
  69   3            // AWAIT_INITIAL_POSITION_SET STATE MANAGEMENT
  70   3            case AWAIT_INITIAL_POSITION_SET:
  71   3              
  72   3              if (JustEnteredState){
  73   4                tm_display_digits(2, 3, 3, 2);
  74   4                if (LED_READY) {
  75   5                  JustEnteredState = 0;
  76   5                  LED_READY = 0;
  77   5                  CurrentBoard = DisplayBoardLEDs;
  78   5                  set_leds(&DisplayBoardLEDs);
  79   5                  DelayCounter = 2;
  80   5                }
  81   4                  break;
  82   4              }
  83   3              
  84   3              if (DelayCounter != 0) break;
  85   3      
  86   3              if (!read_and_verify_sensors()) {
  87   4                DelayCounter = 2;
  88   4                break;
  89   4              }
  90   3              MATCH = compare_boards(&CurrentBoard, &PolledBoard); 
  91   3              
  92   3              if (!MATCH) {
  93   4                DelayCounter = 2;
  94   4                break;
  95   4              }
  96   3              
  97   3              JustEnteredState = 1;
  98   3              CurrentMainState = DETECTING;
  99   3              break;
 100   3              
 101   3              
 102   3            case AWAIT_MOVE_SET:
 103   3              if (JustEnteredState) {
 104   4                  JustEnteredState = 0;
 105   4                  set_leds(&DisplayBoardLEDs);
 106   4                  DelayCounter = 2;
 107   4                  break;
 108   4              }
 109   3              
 110   3              if (DelayCounter != 0) break;
 111   3              
 112   3              // Try to read sensors
 113   3              if (!read_and_verify_sensors()) {
 114   4                  DelayCounter = 2;
 115   4                  break;
C51 COMPILER V9.60.7.0   MAIN                                                              01/30/2026 12:49:44 PAGE 3   

 116   4              }
 117   3              
 118   3              // Check if board matches expected position
 119   3              MATCH = compare_boards(&MoveBoard, &PolledBoard);
 120   3              
 121   3              if (MATCH) {
 122   4                  // Move completed successfully!
 123   4                  U8 FromRank, FromFile, ToRank, ToFile;
 124   4                  
 125   4                  // Extract move coordinates from MoveSquares
 126   4                  // MoveSquares format: [FromRank, FromFile, ToRank, ToFile]
 127   4                  FromRank = MoveSquares[0];
 128   4                  FromFile = MoveSquares[1];
 129   4                  ToRank = MoveSquares[2];
 130   4                  ToFile = MoveSquares[3];
 131   4                  
 132   4                  apply_move((MoveSquares[0] << SHIFT) | MoveSquares[1], (MoveSquares[2] << SHIFT) | MoveSquares[3], 0
             -);
 133   4                  
 134   4                  if (is_game_over()) {
 135   5                    CurrentMainState = GAME_IS_OVER;
 136   5                    JustEnteredState = 1;
 137   5                  }
 138   4                  
 139   4                  // Clear LEDs
 140   4                  CLEAR_LEDS();
 141   4                  
 142   4                  // Back to detecting
 143   4                  CurrentMainState = DETECTING;
 144   4                  CurrentDetectionState = NONE;
 145   4                  JustEnteredState = 1;
 146   4                  
 147   4                  break;
 148   4              }
 149   3              
 150   3              // Board doesn't match yet - keep waiting
 151   3              DelayCounter = 2;
 152   3              break;
 153   3            
 154   3            // DETECTION STATE MANAGEMENT
 155   3            case DETECTING:
 156   3              if (JustEnteredState) {
 157   4                tm_display_digits(3, 4, 4, 3);
 158   4                JustEnteredState = 0;
 159   4                CLEAR_LEDS();
 160   4                DelayCounter = 2;
 161   4                
 162   4              }
 163   3              
 164   3              if (LED_READY) {
 165   4                LED_READY = 0;
 166   4                set_leds(&DisplayBoardLEDs);
 167   4                DelayCounter = 2;
 168   4              }
 169   3      
 170   3              if (DelayCounter != 0) break;
 171   3              
 172   3              if (!read_and_verify_sensors()) {
 173   4                    DelayCounter = 2;
 174   4                    break;
 175   4              }
 176   3                  
C51 COMPILER V9.60.7.0   MAIN                                                              01/30/2026 12:49:44 PAGE 4   

 177   3              MATCH = compare_boards(&CurrentBoard, &PolledBoard);
 178   3      
 179   3              if (!MATCH) {
 180   4                JustEnteredState = 1;
 181   4                CurrentMainState = CHANGE_DETECTED;
 182   4                break;
 183   4              }
 184   3              
 185   3              CLEAR_LEDS();
 186   3              switch (CurrentDetectionState) {
 187   4                case NONE:
 188   4                  break;
 189   4                  
 190   4                case LIFT:
 191   4                  // Check if piece returned to original square
 192   4                  get_left_entered(&CurrentBoard, &PolledBoard);
 193   4                  
 194   4                  if (get_bit_count(&LeftMask) == 0 && get_bit_count(&EnteredMask) == 0) {
 195   5                      // Boards match - piece was returned
 196   5                      U8 FromRank, FromFile;
 197   5                      
 198   5                      FromRank = LiftedPieceSquare >> SHIFT;
 199   5                      FromFile = LiftedPieceSquare & MASK;
 200   5      
 201   5                      
 202   5                      // Verify piece is back on original square
 203   5                      if ((PolledBoard.RANK[FromRank] >> FromFile) & 1) {
 204   6                          CurrentDetectionState = NONE;
 205   6                          LiftedPieceSquare = 0;
 206   6                          CLEAR_LEDS();
 207   6                      } else {
 208   6                          // Boards match but piece not on original square - ERROR
 209   6                          CurrentMainState = ERROR_FLASH_ON;
 210   6                          CurrentDetectionState = NONE;
 211   6                          CLEAR_LEGAL_MOVES();
 212   6                      }
 213   5                  }
 214   4                  break;
 215   4              }
 216   3              
 217   3              DelayCounter = 2;
 218   3              break;
 219   3              
 220   3            // CHANGE_DETECTED STATE MANAGEMENT 
 221   3            case CHANGE_DETECTED:
 222   3              if (JustEnteredState) JustEnteredState = 0;
 223   3                
 224   3                get_left_entered(&CurrentBoard, &PolledBoard);
 225   3                
 226   3                switch (CurrentDetectionState){
 227   4      
 228   4                  case NONE:
 229   4                    tm_display_digits(1, 1, 1, 1);
 230   4                    if (get_bit_count(&LeftMask) == 1 && get_bit_count(&EnteredMask) == 0) {
 231   5                      U8 row, col;
 232   5                      bit found;
 233   5                      found = 0;
 234   5                      
 235   5                      CurrentDetectionState = LIFT;
 236   5                      CurrentMainState = DETECTING;
 237   5                      JustEnteredState = 1;
 238   5                      for (row=0; row<BOARD_W; row++) {
C51 COMPILER V9.60.7.0   MAIN                                                              01/30/2026 12:49:44 PAGE 5   

 239   6                        if (found) break;
 240   6                        for (col=0; col<BOARD_W; col++) {
 241   7                          if ((LeftMask.RANK[row] >> col) & 1) {
 242   8                            get_legal_moves((row << SHIFT) | col, &LegalMoves, 0);
 243   8                            DisplayBoardLEDs = LegalMoves;
 244   8                            LiftedPieceSquare = (row << SHIFT) | col;
 245   8                            LED_READY = 1;
 246   8                            found = 1; 
 247   8                            break;
 248   8                          }
 249   7                        }
 250   6                      }
 251   5                      break;
 252   5                    }
 253   4                    CurrentMainState = ERROR_FLASH_ON;
 254   4                    break;
 255   4                    
 256   4                
 257   4                  case LIFT:
 258   4                    // Piece still lifted
 259   4                    if (get_bit_count(&LeftMask) == 1 && get_bit_count(&EnteredMask) == 0) {
 260   5                      CurrentMainState = DETECTING; 
 261   5                      break;
 262   5                      
 263   5                      // Capture in progress: removed opponent's piece while holding yours
 264   5                    } else if (get_bit_count(&LeftMask) == 2 && get_bit_count(&EnteredMask) == 0) {
 265   5                        bit valid_capture;
 266   5                        U8 i, j;
 267   5                        
 268   5                        valid_capture = 0;
 269   5                        
 270   5                        // Check if one of the left pieces is a legal capture square
 271   5                        for (i=0; i<BOARD_W; i++) {
 272   6                            for (j=0; j<BOARD_W; j++) {
 273   7                                if ((LeftMask.RANK[i] >> j) & 1) {
 274   8                                    // Skip the originally lifted piece
 275   8                                    if (((i<< SHIFT) | j) == ((LiftedPieceSquare >> SHIFT) | (LiftedPieceSquare & MASK))) conti
             -nue;
 276   8                                    
 277   8                                    // Check if this square is a legal capture
 278   8                                    if ((LegalMoves.RANK[i] >> j) & 1) {
 279   9                                        valid_capture = 1;
 280   9                                        break;
 281   9                                    }
 282   8                                }
 283   7                            }
 284   6                            if (valid_capture) break;
 285   6                        }
 286   5                        
 287   5                        if (!valid_capture) {
 288   6                            CurrentMainState = ERROR_FLASH_ON;
 289   6                            CurrentDetectionState = NONE;
 290   6                            CLEAR_LEGAL_MOVES();
 291   6                            break;
 292   6                        }
 293   5                        
 294   5                        // Valid capture - wait for piece to be placed
 295   5                        IntermediateBoard = PolledBoard;
 296   5                        CurrentDetectionState = CAPTURE_INTERMEDIATE;
 297   5                        CurrentMainState = DETECTING;
 298   5                        break;
 299   5                        
C51 COMPILER V9.60.7.0   MAIN                                                              01/30/2026 12:49:44 PAGE 6   

 300   5                    // Piece placed on new square, check if legal
 301   5                    } else if (get_bit_count(&LeftMask) == 1 && get_bit_count(&EnteredMask) == 1) {
 302   5                        bit legal;
 303   5                        U8 ToSquare;
 304   5                        U8 row, col;
 305   5                        
 306   5                        ToSquare = 0;
 307   5                        legal = 0;
 308   5                        
 309   5                        for (row=0; row<BOARD_W; row++) {
 310   6                          if (EnteredMask.RANK[row] & LegalMoves.RANK[row]) {
 311   7                            for (col = 0; col<BOARD_W; col++) if ((EnteredMask.RANK[row] >> col) & 1) break;
 312   7                              ToSquare = (row << SHIFT) | col;
 313   7                              legal = 1;
 314   7                              break;
 315   7                          }
 316   6                        }
 317   5                        
 318   5                        if (!legal) {
 319   6                          CurrentMainState = ERROR_FLASH_ON;
 320   6                          CurrentDetectionState = NONE;
 321   6                          CLEAR_LEGAL_MOVES();
 322   6                          break;
 323   6                        }
 324   5                        
 325   5                        CurrentDetectionState = NONE;
 326   5                        CurrentMainState = DETECTING;
 327   5                        CLEAR_LEGAL_MOVES();
 328   5                        
 329   5                        apply_move(LiftedPieceSquare, ToSquare, 1);
 330   5                        
 331   5                        if (is_game_over()) {
 332   6                          CurrentMainState = GAME_IS_OVER;
 333   6                          JustEnteredState = 1;
 334   6                        }
 335   5                        
 336   5                        break;
 337   5                      
 338   5                    } else {
 339   5                        CurrentMainState = DETECTING; 
 340   5                      break;
 341   5                    }
 342   4                    
 343   4                    
 344   4                  case CAPTURE_INTERMEDIATE:
 345   4                    get_left_entered(&IntermediateBoard, &PolledBoard);
 346   4                  
 347   4                    // Waiting for captured piece to be placed on new square
 348   4                    if (get_bit_count(&LeftMask) == 0 && get_bit_count(&EnteredMask) == 1) {
 349   5                        bit legal;
 350   5                        U8 ToSquare;
 351   5                        U8 i, j;
 352   5                        
 353   5                        legal = 0;
 354   5                        
 355   5                        // Find where piece was placed
 356   5                        for (i=0; i<BOARD_W; i++) {
 357   6                            if (EnteredMask.RANK[i] & LegalMoves.RANK[i]) {
 358   7                                for (j = 0; j<BOARD_W; j++) {
 359   8                                    if ((EnteredMask.RANK[i] >> j) & 1) {
 360   9                                        ToSquare = (i << SHIFT) | j;
 361   9                                        legal = 1;
C51 COMPILER V9.60.7.0   MAIN                                                              01/30/2026 12:49:44 PAGE 7   

 362   9                                        break;
 363   9                                    }
 364   8                                }
 365   7                                if (legal) break;
 366   7                            }
 367   6                        }
 368   5                        
 369   5                        if (!legal) {
 370   6                            CurrentMainState = ERROR_FLASH_ON;
 371   6                            CurrentDetectionState = NONE;
 372   6                            CLEAR_LEGAL_MOVES();
 373   6                            break;
 374   6                        }
 375   5                        
 376   5                        CurrentDetectionState = NONE;
 377   5                        CurrentMainState = DETECTING;
 378   5                        CLEAR_LEGAL_MOVES();
 379   5                        
 380   5                        apply_move(LiftedPieceSquare, ToSquare, 1);
 381   5                        
 382   5                        if (is_game_over()) {
 383   6                          CurrentMainState = GAME_IS_OVER;
 384   6                          JustEnteredState = 1;
 385   6                        }
 386   5                        
 387   5                        break;
 388   5                    }
 389   4                    
 390   4                    // Still in intermediate state
 391   4                    else if (get_bit_count(&LeftMask) == 0 && get_bit_count(&EnteredMask) == 0) {
 392   5                        CurrentMainState = DETECTING;
 393   5                        break;
 394   5                    }
 395   4                    
 396   4                    // Unexpected state
 397   4                    else {
 398   5                        CurrentMainState = ERROR_FLASH_ON;
 399   5                        CurrentDetectionState = NONE;
 400   5                        CLEAR_LEGAL_MOVES();
 401   5                        break;
 402   5                    }
 403   4                    
 404   4                    default:
 405   4                      // Should never reach here, but recover gracefully
 406   4                      CurrentMainState = ERROR_FLASH_ON;
 407   4                      CurrentDetectionState = NONE;
 408   4                      CLEAR_LEGAL_MOVES();
 409   4                      break;
 410   4                  }
 411   3            
 412   3              break;
 413   3              
 414   3            
 415   3            case GAME_IS_OVER:
 416   3              if (JustEnteredState) {
 417   4                Bitboard display_over;
 418   4                U8 square;
 419   4                
 420   4                JustEnteredState = 0;
 421   4                square = KingSquares[TURN];
 422   4                
 423   4                if (GAME_OVER_INFO == 1) {
C51 COMPILER V9.60.7.0   MAIN                                                              01/30/2026 12:49:44 PAGE 8   

 424   5                  display_over.RANK[0] = 0;
 425   5                  display_over.RANK[1] = 0;
 426   5                  display_over.RANK[2] = 0;
 427   5                  display_over.RANK[3] = 0;
 428   5                  display_over.RANK[4] = 0;
 429   5                  display_over.RANK[5] = 0;
 430   5                  display_over.RANK[6] = 0;
 431   5                  display_over.RANK[7] = 0;
 432   5                  display_over.RANK[square >> SHIFT] |= (1 << (square & MASK));
 433   5                } else if (GAME_OVER_INFO == 0) {
 434   5                  display_over.RANK[0] = 0xFF;
 435   5                  display_over.RANK[1] = 0xFF;
 436   5                  display_over.RANK[2] = 0xFF;
 437   5                  display_over.RANK[3] = 0xFF;
 438   5                  display_over.RANK[4] = 0xFF;
 439   5                  display_over.RANK[5] = 0xFF;
 440   5                  display_over.RANK[6] = 0xFF;
 441   5                  display_over.RANK[7] = 0xFF;
 442   5                  
 443   5                  display_over.RANK[square >> SHIFT] &= ~(1 << (square & MASK));
 444   5                }
 445   4                set_leds(&display_over);
 446   4              }
 447   3              break;
 448   3                      
 449   3                    
 450   3            case ERROR_FLASH_ON:
 451   3                if (JustEnteredState) {
 452   4                    JustEnteredState = 0;
 453   4                    set_leds(&OneBoard);  // All LEDs on = ERROR
 454   4                    ErrorFlashCount++;
 455   4                }
 456   3                
 457   3                if (DelayCounter != 0) break;
 458   3                
 459   3                if (ErrorFlashCount >= 6) {
 460   4                    ErrorFlashCount = 0;
 461   4                    
 462   4                    if (read_and_verify_sensors()) {
 463   5                        MATCH = compare_boards(&CurrentBoard, &PolledBoard);
 464   5                        
 465   5                        if (MATCH) {
 466   6                            // Board corrected!
 467   6                            CurrentMainState = DETECTING;
 468   6                            CurrentDetectionState = NONE;
 469   6                            CLEAR_LEDS();
 470   6                            JustEnteredState = 1;
 471   6                            DelayCounter = 10;
 472   6                            break;
 473   6                        }
 474   5                    }
 475   4                    
 476   4                    // Still wrong - show expected position
 477   4                    set_leds(&CurrentBoard);  // Show where pieces SHOULD be
 478   4                    DelayCounter = 50;  // Display for 500ms
 479   4                    ErrorFlashCount = 0;  // Reset to flash again
 480   4                    break;
 481   4                }
 482   3                
 483   3                CurrentMainState = ERROR_FLASH_OFF;
 484   3                DelayCounter = 10;
 485   3                JustEnteredState = 1;
C51 COMPILER V9.60.7.0   MAIN                                                              01/30/2026 12:49:44 PAGE 9   

 486   3                break;
 487   3      
 488   3            case ERROR_FLASH_OFF:
 489   3              if (JustEnteredState) {
 490   4                  JustEnteredState = 0;
 491   4                  CLEAR_LEDS();
 492   4              }
 493   3              
 494   3              if (DelayCounter != 0) break;
 495   3              CurrentMainState = ERROR_FLASH_ON;
 496   3              DelayCounter = 10;
 497   3              JustEnteredState = 1;
 498   3              break;
 499   3          
 500   3          }
 501   2          
 502   2          delay_ms(10);
 503   2        }
 504   1      }
 505          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1495    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
